name: Production Build & Deploy

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy_web:
    name: Build Web & Deploy Firebase
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm ci

      - name: Create production env file
        run: echo "VITE_API_KEY=${{ secrets.VITE_API_KEY }}" > .env.production

      - name: Build Web Project
        run: npm run build
        env:
          VITE_API_KEY: ${{ secrets.VITE_API_KEY }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_VERUM_OMNIS_ENGINE }}'
          channelId: live
          projectId: verum-omnis-engine

  build_android_apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: build_and_deploy_web
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm ci

      - name: Create production env file
        run: |
          echo "VITE_API_KEY=${{ secrets.VITE_API_KEY }}" > .env.production
          echo "VITE_OPENAI_API_KEY=${{ secrets.VITE_OPENAI_API_KEY }}" >> .env.production
          echo "VITE_PREFERRED_API=openai" >> .env.production

      - name: Build Web Assets
        run: npm run build
        env:
          VITE_API_KEY: ${{ secrets.VITE_API_KEY }}
          VITE_OPENAI_API_KEY: ${{ secrets.VITE_OPENAI_API_KEY }}
          VITE_PREFERRED_API: openai

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build Android APK (Release)
        run: cd android && ./gradlew assembleRelease

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: verum-omnis-release-apk
          path: android/app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 90

      - name: Get version from package.json
        id: package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.package-version.outputs.version }}-${{ github.run_number }}
          name: Verum Omnis v${{ steps.package-version.outputs.version }} Build ${{ github.run_number }}
          body: |
            ## Verum Omnis - Forensic Engine
            
            **Court-Accepted Legal AI with Multi-Modal Evidence Analysis**
            
            ### üèÜ Gold Standard
            Evidence from this system has been accepted in court by law enforcement and law firms in South Africa and UAE.
            
            ### üì± Download APK
            Download the Android APK below to install Verum Omnis on your Android device.
            
            ### ‚ú® Features
            - **Free Access to Justice**: Free forensic analysis for all private citizens worldwide
            - **Works Offline**: Full functionality without internet connection
            - **Multi-Modal Analysis**: Supports images, audio, video, documents, and financial records
            - **Fraud Firewall**: Real-time fraud detection for banks and institutions
            - **Cryptographic Sealing**: All evidence SHA-256 hashed for court admissibility
            - **Multi-Jurisdictional**: Works in every jurisdiction on earth
            
            ### üîí Security
            - All data processed on-device
            - No cloud uploads
            - Cryptographically sealed reports
            - Chain of custody maintained
            
            **Build:** ${{ github.run_number }}  
            **Commit:** ${{ github.sha }}
          files: |
            android/app/build/outputs/apk/release/app-release-unsigned.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
